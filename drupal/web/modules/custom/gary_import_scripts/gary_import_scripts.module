<?php

/**
 * @file
 * Contains gary_import_scripts.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
/**
 * Implements hook_help().
 */
function gary_import_scripts_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the gary_import_scripts module.
    case 'help.page.gary_import_scripts':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Gary Import Scripts') . '</p>';
      return $output;

    default:
  }
}

function attachServiceTasksToServices() {
  $nodes = serviceIds();
  $node_storage = \Drupal::entityTypeManager()->getStorage('node');
  foreach ($nodes as $node_id => $auto_task_ids) {
      $node = $node_storage->load($node_id);
      if ($node->bundle() == 'services') {
        if ($node->hasField('field_service_tasks')) {
          $current = $node->get('field_service_tasks')->getValue();
          $auto_task_array = explode(',',$auto_task_ids);
          foreach ($auto_task_array as $old_auto_task_id) {
            $new_auto_task_id = getAutoTaskId($old_auto_task_id);
            if (!empty($new_auto_task_id)) {
              $current[] = [
                'target_id' => $new_auto_task_id
              ];
            } else {
              $messenger = \Drupal::messenger();
              $messenger->addMessage('COULD NOT FIND NEW ID!'.$old_auto_task_id, $messenger::TYPE_WARNING);
            }
          }
          $node->set('field_service_tasks', $current);
          $node->save();
        } else {
          // dpm('no field');
        }
      } else {
        // dpm('no bundle');
      }
  }
  // $entity->set('field_service_tasks', 6796);
  // $entity->set('field_service_tasks', 6820);
  // $entity->save();
}

function gary_import_scripts_entity_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  // ksm(count(autoTaskIds()));
  if (isset($_GET['process']) == 1) {
    // ksm($entity->get('field_service_tasks')->getValue());
    // attachServiceTasksToServices();
    // $x = importAutoTaskWeights();
  }


}

function importAutoTaskWeights() {
  $tasks = autoTaskWeights();
  $node_storage = \Drupal::entityTypeManager()->getStorage('node');

  foreach ($tasks as $nid => $task_weight) {
    if (!empty($task_weight)) {
      $node = $node_storage->load($nid);
      if ($node->hasField('field_task_weight')) {
        // dpm($task_weight);
        $node->set('field_task_weight', $task_weight);
        // $node->save();
      }
    }
  }
}

function autoTaskWeights() {

  return [
    '6699' => '0',
    '6700' => '1',
    '6701' => '2',
    '6702' => '3',
    '6703' => '4',
    '6704' => '5',
    '6705' => '',
    '6706' => '',
    '6707' => '',
    '6708' => '0',
    '6709' => '',
    '6710' => '',
    '6711' => '1',
    '6712' => '2',
    '6713' => '3',
    '6714' => '5',
    '6715' => '0',
    '6716' => '1',
    '6717' => '2',
    '6718' => '3',
    '6719' => '4',
    '6720' => '5',
    '6721' => '',
    '6722' => '',
    '6723' => '',
    '6724' => '0',
    '6725' => '',
    '6726' => '1',
    '6727' => '2',
    '6728' => '3',
    '6729' => '5',
    '6730' => '0',
    '6731' => '1',
    '6732' => '2',
    '6733' => '3',
    '6734' => '4',
    '6735' => '5',
    '6736' => '6',
    '6737' => '',
    '6738' => '0',
    '6739' => '1',
    '6740' => '5',
    '6741' => '2',
    '6742' => '3',
    '6743' => '4',
    '6744' => '6',
    '6745' => '0',
    '6746' => '0',
    '6747' => '1',
    '6748' => '2',
    '6749' => '3',
    '6750' => '4',
    '6751' => '5',
    '6752' => '6',
    '6753' => '',
    '6754' => '',
    '6755' => '0',
    '6756' => '0',
    '6757' => '',
    '6758' => '1',
    '6759' => '2',
    '6760' => '3',
    '6761' => '5',
    '6762' => '0',
    '6763' => '1',
    '6764' => '2',
    '6765' => '3',
    '6766' => '4',
    '6767' => '5',
    '6768' => '6',
    '6769' => '0',
    '6770' => '1',
    '6771' => '0',
    '6772' => '4',
    '6773' => '',
    '6774' => '',
    '6775' => '1',
    '6776' => '2',
    '6777' => '3',
    '6778' => '5',
    '6779' => '0',
    '6780' => '4',
    '6781' => '1',
    '6782' => '2',
    '6783' => '3',
    '6784' => '5',
    '6785' => '0',
    '6786' => '4',
    '6787' => '1',
    '6788' => '2',
    '6789' => '3',
    '6790' => '5',
    '6791' => '0',
    '6792' => '4',
    '6793' => '1',
    '6794' => '2',
    '6795' => '3',
    '6796' => '0',
    '6797' => '',
    '6798' => '0',
    '6799' => '1',
    '6800' => '2',
    '6801' => '3',
    '6802' => '4',
    '6803' => '6',
    '6804' => '4',
    '6805' => '5',
    '6806' => '4',
    '6807' => '4',
    '6808' => '0',
    '6809' => '1',
    '6810' => '2',
    '6811' => '3',
    '6812' => '0',
    '6813' => '1',
    '6814' => '2',
    '6815' => '3',
    '6816' => '4',
    '6817' => '5',
    '6818' => '5',
    '6819' => '7',
    '6820' => '1',
    '6821' => '0',
    '6822' => '1',
    '6823' => '2',
    '6824' => '3',
    '6825' => '4',
    '6826' => '5',
    '6827' => '0',
    '6828' => '1',
    '6829' => '2',
    '6830' => '3',
    '6831' => '4',
    '6832' => '5',
    '6833' => '0',
    '6834' => '1',
    '6835' => '2',
    '6836' => '3',
    '6837' => '4',
    '6838' => '5',
    '6839' => '0',
    '6840' => '0',
    '6841' => '0',
    '6842' => '0',
    '6843' => '0',
    '6844' => '0'
  ];

}


function getAutoTaskId($old_auto_task_id) {
  $auto_task_ids = autoTaskIds();
  return $auto_task_ids[$old_auto_task_id];
}
function serviceIds() {
  //key = new id
  //value = string of audit ids to attach to the service
  return [
    '6879'=>'5827',
    '6895'=>'5846',
    '6863'=>'22538,22540,22541,22542,22543,22545',
    '6864'=>'23558,23559,23560,23561,23562,23564',
    '6862'=>'23575,23574,23576,23577,23578,28119',
    '6888'=>'23582,28378',
    '6861'=>'23887,23888,23889,23890,23891,23892,23893,25673',
    '6873'=>'26977,26978,26979,26980',
    '6889'=>'26982,26983,26984,26985,26986,26987',
    '6860'=>'32431,32432,32433,32434,32435,32436',
    '6865'=>'33048,33049,33050,33051,33052,33053',
    '6866'=>'33055,33056,33058,33059,33060,33061',
    '6867'=>'35148,35149,35150,35151,35152,35153',
    '6868'=>'5773,5775,5776,5774,5777,5778,5779,5781',
    '6852'=>'5782,5783,5784,5785,5786,5787,5788,5790,25975',
    '6869'=>'5791,5792,5793,5794,5795,5796,5797,5799',
    '6853'=>'5800,5801,5803,5804,5805,5806,5808,24617',
    '6870'=>'5809,5810,5811,5812,5813,5814,5815,5817',
    '6854'=>'5818,5819,5821,5822,5823,5824,5826',
    '6871'=>'5828,5829,5830,5831,5832,5833,5834,5835,5836',
    '6859'=>'5847,5849,5850,5851,5852,5854,25919',
    '6875'=>'5855,5856,5857,5858,5859,5860,5861,28377',
    '6849'=>'5862,5863',
    '6872'=>'5864,5865,5866,5867,5868,5869,5870,5872',

  ];
}

function autoTaskIds() {
  //key = audit id
  //value = new id
  return  [
    '33059'=>'6836',
    '33060'=>'6837',
    '33061'=>'6838',
    '35148'=>'6839',
    '35149'=>'6840',
    '35150'=>'6841',
    '35151'=>'6842',
    '35152'=>'6843',
    '35153'=>'6844',
    '26980'=>'6811',
    '26982'=>'6812',
    '26983'=>'6813',
    '26984'=>'6814',
    '26985'=>'6815',
    '26986'=>'6816',
    '26987'=>'6817',
    '28119'=>'6818',
    '28377'=>'6819',
    '28378'=>'6820',
    '32431'=>'6821',
    '32432'=>'6822',
    '32433'=>'6823',
    '32434'=>'6824',
    '32435'=>'6825',
    '32436'=>'6826',
    '33048'=>'6827',
    '33049'=>'6828',
    '33050'=>'6829',
    '33051'=>'6830',
    '33052'=>'6831',
    '33053'=>'6832',
    '33055'=>'6833',
    '33056'=>'6834',
    '33058'=>'6835',
    '23887'=>'6797',
    '23888'=>'6798',
    '23889'=>'6799',
    '23890'=>'6800',
    '23891'=>'6801',
    '23892'=>'6802',
    '23893'=>'6803',
    '24617'=>'6804',
    '25673'=>'6805',
    '25919'=>'6806',
    '25975'=>'6807',
    '26977'=>'6808',
    '26978'=>'6809',
    '26979'=>'6810',
    '5865'=>'6772',
    '5866'=>'6773',
    '5867'=>'6774',
    '5868'=>'6775',
    '5869'=>'6776',
    '5870'=>'6777',
    '5872'=>'6778',
    '22538'=>'6779',
    '22540'=>'6780',
    '22541'=>'6781',
    '22542'=>'6782',
    '22543'=>'6783',
    '22545'=>'6784',
    '23558'=>'6785',
    '23559'=>'6786',
    '23560'=>'6787',
    '23561'=>'6788',
    '23562'=>'6789',
    '23564'=>'6790',
    '23574'=>'6791',
    '23575'=>'6792',
    '23576'=>'6793',
    '23577'=>'6794',
    '23578'=>'6795',
    '23582'=>'6796',
    '5829'=>'6747',
    '5830'=>'6748',
    '5831'=>'6749',
    '5832'=>'6750',
    '5833'=>'6751',
    '5834'=>'6752',
    '5835'=>'6753',
    '5836'=>'6754',
    '5846'=>'6755',
    '5847'=>'6756',
    '5849'=>'6757',
    '5850'=>'6758',
    '5851'=>'6759',
    '5852'=>'6760',
    '5854'=>'6761',
    '5855'=>'6762',
    '5856'=>'6763',
    '5857'=>'6764',
    '5858'=>'6765',
    '5859'=>'6766',
    '5860'=>'6767',
    '5861'=>'6768',
    '5862'=>'6769',
    '5863'=>'6770',
    '5864'=>'6771',
    '5801'=>'6724',
    '5803'=>'6725',
    '5804'=>'6726',
    '5805'=>'6727',
    '5806'=>'6728',
    '5808'=>'6729',
    '5809'=>'6730',
    '5810'=>'6731',
    '5811'=>'6732',
    '5812'=>'6733',
    '5813'=>'6734',
    '5814'=>'6735',
    '5815'=>'6736',
    '5817'=>'6737',
    '5818'=>'6738',
    '5819'=>'6739',
    '5821'=>'6740',
    '5822'=>'6741',
    '5823'=>'6742',
    '5824'=>'6743',
    '5826'=>'6744',
    '5827'=>'6745',
    '5828'=>'6746',
    '5774'=>'6700',
    '5775'=>'6701',
    '5776'=>'6702',
    '5777'=>'6703',
    '5778'=>'6704',
    '5779'=>'6705',
    '5781'=>'6706',
    '5782'=>'6707',
    '5783'=>'6708',
    '5784'=>'6709',
    '5785'=>'6710',
    '5786'=>'6711',
    '5787'=>'6712',
    '5788'=>'6713',
    '5790'=>'6714',
    '5791'=>'6715',
    '5792'=>'6716',
    '5793'=>'6717',
    '5794'=>'6718',
    '5795'=>'6719',
    '5796'=>'6720',
    '5797'=>'6721',
    '5799'=>'6722',
    '5800'=>'6723',
    '5773'=>'6699',
  ];
}
